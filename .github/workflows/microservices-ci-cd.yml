name: Microservices CI/CD with Docker   #  TÃªn workflow hiá»ƒn thá»‹ trÃªn GitHub Actions UI

on:
  push:
    branches: [ "main" ]               # ðŸš€ Cháº¡y khi cÃ³ push lÃªn nhÃ¡nh main
  pull_request:
    branches: [ "main" ]               # âœ… Kiá»ƒm tra khi cÃ³ PR gá»­i vÃ o nhÃ¡nh main

jobs:
  test:                                # ðŸ§ª Job Ä‘áº§u tiÃªn: cháº¡y test cho tá»«ng service
    runs-on: ubuntu-latest             # MÃ´i trÆ°á»ng cháº¡y: Ubuntu má»›i nháº¥t
    
    services:                          # ðŸ“¦ CÃ¡c service phá»¥ trá»£ cáº§n cho test (database, message broker)
      mongodb:
        image: mongo:6                 # MongoDB version 6
        ports:
          - 27017:27017
      
      rabbitmq:
        image: rabbitmq:3.8-management-alpine  # RabbitMQ nháº¹, cÃ³ giao diá»‡n quáº£n lÃ½
        ports:
          - 5672:5672

    strategy:
      matrix:
        service: [auth, order, product, api-gateway]  # ðŸ” Cháº¡y test song song cho cÃ¡c service nÃ y
        node-version: [20.x]                         # DÃ¹ng Node.js 20

    steps:
    - uses: actions/checkout@v4                      # â¬‡ï¸ Clone code repo vá» runner
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4                    # âš™ï¸ CÃ i Ä‘áº·t Node.js
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'                                 # Tá»± Ä‘á»™ng cache thÆ° má»¥c node_modules
        cache-dependency-path: ${{ matrix.service }}/package-lock.json

    - name: Install dependencies
      working-directory: ./${{ matrix.service }}     # ðŸ’¿ Di chuyá»ƒn vÃ o tá»«ng thÆ° má»¥c service
      run: npm ci                                   # CÃ i Ä‘áº·t dependencies tá»« package-lock.json

    - name: Run tests
      working-directory: ./${{ matrix.service }}
      run: npm test --if-present || echo "No test for ${{ matrix.service }}"  # âœ… Cháº¡y test, bá» qua náº¿u khÃ´ng cÃ³

    - name: Build
      working-directory: ./${{ matrix.service }}
      run: npm run build --if-present                # ðŸ—ï¸ Build tá»«ng service náº¿u cÃ³ script build

  docker-build-push:
    needs: test                                      # ðŸ”— Cháº¡y sau khi job test hoÃ n táº¥t
    runs-on: ubuntu-latest
    if: github.event_name == 'push'                 # ðŸ§­ Chá»‰ cháº¡y khi push (khÃ´ng cháº¡y khi PR)
    
    strategy:
      matrix:
        service: [auth, order, product, api-gateway]  # Láº·p qua tá»«ng service Ä‘á»ƒ build docker

    steps:
    - uses: actions/checkout@v4                      # Clone láº¡i repo

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3            # âš™ï¸ DÃ¹ng Buildx Ä‘á»ƒ há»— trá»£ multi-platform build

    - name: Login to Docker Hub
      uses: docker/login-action@v3                   # ðŸ” ÄÄƒng nháº­p Docker Hub
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push ${{ matrix.service }}
      uses: docker/build-push-action@v5               # ðŸ³ Build vÃ  push image lÃªn Docker Hub
      with:
        context: ./${{ matrix.service }}              # ThÆ° má»¥c context tÆ°Æ¡ng á»©ng service
        push: true
        tags: |                                       # ðŸ·ï¸ Tag image vá»›i latest vÃ  SHA
          ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}-cicd:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}-cicd:${{ github.sha }}

  deploy:
    needs: docker-build-push                         # ðŸ§© Cháº¡y sau khi build & push Docker image xong
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # ðŸ”¥ Chá»‰ deploy khi push main
    
    steps:
    - uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3                   # ðŸ” ÄÄƒng nháº­p Docker Hub
      with:
        username: ${{ secrets.DOCKER_USERNAME }}      # âœ… Sá»¬A DÃ’NG NÃ€Y: Ä‘áº£m báº£o Ä‘á»c tá»« GitHub Secrets
        password: ${{ secrets.DOCKER_PASSWORD }}      # âœ… Sá»¬A DÃ’NG NÃ€Y

    - name: Create production compose file
      run: |                                          # ðŸ§¾ Táº¡o file docker-compose.prod.yml Ä‘á»ƒ deploy
        cat > docker-compose.prod.yml << EOF
        version: "3.9"
        services:
          auth:
            image: ${{ secrets.DOCKER_USERNAME }}/auth-cicd:latest
            container_name: 'auth-cicd'
            ports:
              - "3000:3000"
            networks:
              - cicd-network

          rabbitmq:
            image: rabbitmq:3.8-management-alpine
            container_name: 'rabbitmq-cicd'
            ports:
              - "5672:5672"
              - "15672:15672"
            volumes:
              - rabbitmq_data:/var/lib/rabbitmq/
            networks:
              - cicd-network

          order:
            image: ${{ secrets.DOCKER_USERNAME }}/order-cicd:latest
            container_name: 'order-cicd'
            ports:
              - "3002:3002"
            depends_on:
              - rabbitmq
            environment:
              - RABBITMQ_URL=amqp://rabbitmq-cicd:5672
            networks:
              - cicd-network

          product:
            image: ${{ secrets.DOCKER_USERNAME }}/product-cicd:latest
            container_name: 'product-cicd'
            ports:
              - "3001:3001"
            depends_on:
              - rabbitmq
            environment:
              - RABBITMQ_URL=amqp://rabbitmq-cicd:5672
            networks:
              - cicd-network

          api-gateway:
            image: ${{ secrets.DOCKER_USERNAME }}/api-gateway-cicd:latest
            container_name: 'gateway-cicd'
            ports:
              - "3003:3003"
            environment:
              - RABBITMQ_URL=amqp://rabbitmq-cicd:5672
            networks:
              - cicd-network

          mongo:
            image: mongo:6
            container_name: 'mongodb-cicd'
            ports:
              - "27017:27017"
            volumes:
              - mongo_data:/data/db
            networks:
              - cicd-network

        networks:
          cicd-network:
            driver: bridge

        volumes:
          mongo_data:
          rabbitmq_data:
        EOF

    - name: Ensure Docker is running
      run: docker info                               # ðŸ” Kiá»ƒm tra Docker Ä‘Ã£ hoáº¡t Ä‘á»™ng chÆ°a

    - name: Pull vÃ  start services
      run: |                                          # ðŸš¢ KÃ©o image má»›i vÃ  khá»Ÿi Ä‘á»™ng cÃ¡c container
        docker compose -f docker-compose.prod.yml pull
        docker compose -f docker-compose.prod.yml up -d
        sleep 20
        docker compose -f docker-compose.prod.yml ps  # Kiá»ƒm tra tráº¡ng thÃ¡i container

    - name: Test services
      run: |                                          # ðŸ§­ Kiá»ƒm tra cÃ¡c service chÃ­nh pháº£n há»“i OK
        curl -f http://localhost:3003 || echo "Gateway OK"
        curl -f http://localhost:3000 || echo "Auth OK"
        curl -f http://localhost:3001 || echo "Product OK"
        curl -f http://localhost:3002 || echo "Order OK"

    - name: Cleanup
      if: always()
      run: docker compose -f docker-compose.prod.yml down  # ðŸ§¹ Dá»n dáº¹p container sau khi kiá»ƒm tra xong
